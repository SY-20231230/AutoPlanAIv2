# gemini_gantt.py
# DBì˜ í™•ì •ëœ Requirementë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°„íŠ¸ì°¨íŠ¸ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ ìœ í‹¸ í•¨ìˆ˜ ëª¨ìŒ
# - ì™¸ë¶€ì—ì„œ(views.py) project ê°ì²´ì™€ Requirement querysetì„ ë°›ì•„ prompt ìƒì„±
# - Gemini í˜¸ì¶œ í›„ ì‘ë‹µ(JSON ë°°ì—´) íŒŒì‹±
# - openpyxlë¡œ .xlsx ìƒì„±

import os
import json
import re
from datetime import datetime
from collections import defaultdict

import openpyxl
from openpyxl.styles import PatternFill, Border, Side, Alignment
from openpyxl.utils import get_column_letter

import google.generativeai as genai
from dotenv import load_dotenv

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) í™˜ê²½ë³€ìˆ˜/LLM ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()  # .env ì—ì„œ GEMINI_API_KEY_3 ë¡œë“œ
genai.configure(api_key=os.getenv("GEMINI_API_KEY_3"))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) ìƒ‰ìƒ ë§µ (íŒŒíŠ¸ë³„ ì±„ìš°ê¸° ìƒ‰ìƒ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COLOR_MAP = {
    "ë°±ì—”ë“œ": "FF6666",
    "í”„ë¡ íŠ¸ì—”ë“œ": "66B2FF",
    "í•˜ë“œì›¨ì–´": "66CC99",
    "ì¸ê³µì§€ëŠ¥": "9999FF",
    "ì„œë¥˜": "CCCCCC",
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) DB â†’ í”„ë¡¬í”„íŠ¸ ì…ë ¥ìš© JSON ë³€í™˜
#    - í”„ë¡œì íŠ¸/ìš”êµ¬ì‚¬í•­ ëª¨ë¸ì„ ì§ì ‘ importí•˜ì§€ ì•Šê³ , duck-typingìœ¼ë¡œ ì ‘ê·¼
#    - viewsì—ì„œ Requirement.objects.filter(...confirmed_by_user=True) ì „ë‹¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def build_payload_from_db(project, requirements_queryset):
    """
    project: Project ì¸ìŠ¤í„´ìŠ¤ (title, description ì†ì„± ì‚¬ìš©)
    requirements_queryset: Requirement ì¿¼ë¦¬ì…‹
      - ê° ê°ì²´ëŠ” ë‹¤ìŒ ì†ì„±ì„ ê°€ì •:
        .Requirement (PK), .feature_name, .summary, .description(JSON ë¬¸ìì—´ì¼ ìˆ˜ë„), .project

    ë°˜í™˜ê°’ ì˜ˆì‹œ:
    {
      "project": {"title": "...", "description": "..."},
      "features": [
        {"ê¸°ëŠ¥ID": 1, "ê¸°ëŠ¥ëª…": "ë¡œê·¸ì¸", "ìš”ì•½": "...", "ì›ë³¸": {...}},
        ...
      ]
    }
    """
    items = []
    for r in requirements_queryset:
        # descriptionì— JSONì´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ˆì „ íŒŒì‹±
        src = {}
        if getattr(r, "description", None):
            try:
                src = json.loads(r.description)
            except Exception:
                src = {}
        items.append({
            "ê¸°ëŠ¥ID": getattr(r, "Requirement", None),
            "ê¸°ëŠ¥ëª…": getattr(r, "feature_name", "") or "ê¸°ëŠ¥",
            "ìš”ì•½": getattr(r, "summary", "") or "",
            "ì›ë³¸": src,
        })

    payload = {
        "project": {
            "title": getattr(project, "title", "") or "",
            "description": getattr(project, "description", "") or "",
        },
        "features": items,
    }
    return payload

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) í”„ë¡¬í”„íŠ¸ ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def make_prompt(json_data: dict, parts: list, total_weeks: int, feedback: str = None) -> str:
    """
    json_data: build_payload_from_db ë¡œ ìƒì„±ëœ dict
    parts: ["ë°±ì—”ë“œ","í”„ë¡ íŠ¸ì—”ë“œ", ...]
    total_weeks: ì „ì²´ í”„ë¡œì íŠ¸ ê¸°ê°„(ì£¼)
    feedback: ì¬ìƒì„± ì‹œ ë°˜ì˜í•  ì½”ë©˜íŠ¸(ì„ íƒ)
    """
    base_prompt = f"""
ë‹¹ì‹ ì€ ì†Œí”„íŠ¸ì›¨ì–´ ê¸°íš ì „ë¬¸ê°€ì´ì í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ì…ë‹ˆë‹¤.

ì•„ë˜ëŠ” í•˜ë‚˜ì˜ í”„ë¡œì íŠ¸ì— ëŒ€í•œ ê¸°íšì„œì™€ í™•ì •ëœ ê¸°ëŠ¥ëª…ì„¸ì„œ ëª©ë¡ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, ì§€ì •ëœ ê°œë°œ íŒŒíŠ¸ë“¤ ì¤‘ í•˜ë‚˜ ì´ìƒì— ê° ê¸°ëŠ¥ì„ ë°°ì •í•˜ê³ ,
ì „ì²´ í”„ë¡œì íŠ¸ ê¸°ê°„ {total_weeks}ì£¼ ì•ˆì—ì„œ ê°€ëŠ¥í•œ í˜„ì‹¤ì ì¸ ê°„íŠ¸ì°¨íŠ¸ë¥¼ êµ¬ì„±í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

âœ… ê°œë°œ íŒŒíŠ¸ ëª©ë¡:
- {", ".join(parts)}

âœ… ì§€ì¼œì•¼ í•  ê·œì¹™:
1) ê° ê¸°ëŠ¥ì„ ì ì ˆí•œ ê°œë°œ íŒŒíŠ¸(ë³µìˆ˜ ê°€ëŠ¥)ì— ë°°ì •í•˜ì„¸ìš”.
2) ì„ í›„ ê´€ê³„ê°€ ìˆë‹¤ë©´ "ì„ í–‰ì‘ì—…" í•„ë“œì— ê¸°ëŠ¥ID ëª©ë¡ ë˜ëŠ” ë‹¨ì¼ ê°’ìœ¼ë¡œ í‘œí˜„í•˜ì„¸ìš”. (ì—†ìœ¼ë©´ null)
3) ê° ê¸°ëŠ¥ì˜ ê¸°ê°„ì€ "ì£¼" ë‹¨ìœ„ ì •ìˆ˜ë¡œ ì¶”ì •í•˜ì„¸ìš”.
4) "ì‹œì‘ì£¼ì°¨"ëŠ” 1ë¶€í„° ì‹œì‘í•˜ëŠ” ì •ìˆ˜ì…ë‹ˆë‹¤.
5) ê¸°ëŠ¥IDê°€ ì—†ë‹¤ë©´ F-001, F-002... í˜•ì‹ìœ¼ë¡œ ìë™ ìƒì„±í•˜ì„¸ìš”.
6) ì¶œë ¥ì€ ë°˜ë“œì‹œ JSON ë°°ì—´ë§Œ ë°˜í™˜í•˜ì„¸ìš”. (ì„¤ëª… í…ìŠ¤íŠ¸ ê¸ˆì§€)

[ì¶œë ¥ JSON í˜•ì‹ ì˜ˆì‹œ]
[
  {{
    "ê¸°íšì„œìš”ì•½": "í•´ë‹¹ ê¸°ëŠ¥ì´ ì™œ í•„ìš”í•œì§€ í•œ ì¤„ ìš”ì•½",
    "ê¸°ëŠ¥ID": "F-001",
    "ê¸°ëŠ¥ëª…": "ì‚¬ìš©ì ë¡œê·¸ì¸",
    "íŒŒíŠ¸": ["ë°±ì—”ë“œ","í”„ë¡ íŠ¸ì—”ë“œ"],
    "ê¸°ê°„": 2,
    "ì‹œì‘ì£¼ì°¨": 1,
    "ì„ í–‰ì‘ì—…": null
  }},
  ...
]
""".strip()

    if feedback:
        base_prompt += f"\n\nğŸ“Œ ì‚¬ìš©ì í”¼ë“œë°±:\n{feedback}"

    # ì…ë ¥ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ í¬í•¨
    base_prompt += f"\n\nâœï¸ í”„ë¡œì íŠ¸/ê¸°ëŠ¥ ì „ì²´ ë°ì´í„°(JSON):\n```json\n{json.dumps(json_data, ensure_ascii=False, indent=2)}\n```"
    return base_prompt

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) Gemini í˜¸ì¶œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def call_gemini(prompt: str) -> str:
    """
    Gemini 2.5 Flash í˜¸ì¶œ. text ê²°ê³¼ë§Œ ë°˜í™˜.
    """
    model = genai.GenerativeModel("gemini-1.5-flash")
    resp = model.generate_content(prompt)
    return (resp.text or "").strip()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) LLM ì‘ë‹µ(JSON ë°°ì—´) íŒŒì‹±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def parse_llm_array(text: str):
    """
    LLMì´ JSON ì™¸ ì„¤ëª…ì„ ì„ì–´ì¤„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë°°ì—´ ë¶€ë¶„ë§Œ ì•ˆì „ ì¶”ì¶œ.
    ë°˜í™˜: list (ì‘ì—… í•­ëª©ë“¤)
    """
    try:
        data = json.loads(text)
        if isinstance(data, list):
            return data
        # dict ë“±ìœ¼ë¡œ ê°ì‹¸ì ¸ ì˜¨ ê²½ìš° ë°°ì—´ í›„ë³´ ì¶”ì¶œ
    except Exception:
        pass

    m = re.search(r"\[\s*\{.*?\}\s*\]", text, re.DOTALL)
    if not m:
        raise ValueError("LLM ì‘ë‹µì—ì„œ ìœ íš¨í•œ JSON ë°°ì—´ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
    return json.loads(m.group(0))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7) ê°„íŠ¸ì°¨íŠ¸ ì—‘ì…€(.xlsx) ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def build_gantt_xlsx(parsed_data: list, total_weeks: int, available_parts: list, save_path: str):
    """
    parsed_data ì˜ˆì‹œ ì›ì†Œ:
    {
      "ê¸°íšì„œìš”ì•½": "...",
      "ê¸°ëŠ¥ID": "F-001" ë˜ëŠ” ì‹¤ì œ ID,
      "ê¸°ëŠ¥ëª…": "ë¡œê·¸ì¸",
      "íŒŒíŠ¸": ["ë°±ì—”ë“œ","í”„ë¡ íŠ¸ì—”ë“œ"],
      "ê¸°ê°„": 2,
      "ì‹œì‘ì£¼ì°¨": 1,
      "ì„ í–‰ì‘ì—…": null ë˜ëŠ” ["F-000"] ë“±
    }
    """
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "Gantt Chart"

    # í—¤ë”(2í–‰ êµ¬ì¡°)
    weeks = [f"{i+1}ì£¼ì°¨" for i in range(int(total_weeks))]
    ws.merge_cells(start_row=1, start_column=1, end_row=2, end_column=1)
    ws["A1"] = "íŒŒíŠ¸"
    ws.merge_cells(start_row=1, start_column=2, end_row=2, end_column=2)
    ws["B1"] = "ê¸°ëŠ¥ëª…"

    for i, w in enumerate(weeks):
        c = ws.cell(row=1, column=3+i, value=w)
        c.alignment = Alignment(horizontal="center", vertical="center")

    # ì…€ í…Œë‘ë¦¬
    border = Border(
        left=Side(style="thin"), right=Side(style="thin"),
        top=Side(style="thin"), bottom=Side(style="thin")
    )

    # íŒŒíŠ¸ë³„ ê·¸ë£¹í•‘
    grouped = defaultdict(list)
    for task in parsed_data:
        parts = task.get("íŒŒíŠ¸") or ["ê¸°íƒ€"]
        for p in parts:
            grouped[str(p)].append(task)

    # ë³¸ë¬¸ ê·¸ë¦¬ê¸°
    row = 3
    for part in available_parts:
        part = str(part)
        tasks = grouped.get(part, [])
        if not tasks:
            continue

        start_row = row
        for t in tasks:
            name = t.get("ê¸°ëŠ¥ëª…") or t.get("ê¸°ëŠ¥ID") or "ì‘ì—…"
            start = int(t.get("ì‹œì‘ì£¼ì°¨", 1))
            duration = int(t.get("ê¸°ê°„", 1))

            ws.cell(row=row, column=1, value=part)
            ws.cell(row=row, column=2, value=name)

            for j in range(int(total_weeks)):
                cell = ws.cell(row=row, column=3+j)
                # ê°„íŠ¸ ë°” ì±„ìš°ê¸°
                if start-1 <= j < start-1 + duration:
                    cell.fill = PatternFill(
                        start_color=COLOR_MAP.get(part, "AAAAAA"),
                        fill_type="solid"
                    )
                cell.border = border
            row += 1

        # íŒŒíŠ¸ ë¨¸ì§€/ì •ë ¬
        ws.merge_cells(start_row=start_row, start_column=1, end_row=row-1, end_column=1)
        ws.cell(row=start_row, column=1).alignment = Alignment(horizontal="center", vertical="center")

    # ì»¬ëŸ¼ ë„ˆë¹„
    ws.column_dimensions["A"].width = 12
    ws.column_dimensions["B"].width = 30
    for col in range(3, 3 + int(total_weeks)):
        ws.column_dimensions[get_column_letter(col)].width = 6

    # ì €ì¥
    wb.save(save_path)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 8) (ì„ íƒ) ìœ í‹¸: ê³ ìœ  íŒŒì¼ëª… ë§Œë“¤ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def unique_filename(outdir: str, base: str = "ê°„íŠ¸ì°¨íŠ¸", ext: str = ".xlsx") -> str:
    """
    ê°™ì€ í´ë”ì— ê°™ì€ íŒŒì¼ëª…ì´ ìˆìœ¼ë©´ ë’¤ì— _1, _2... ë¶™ì—¬ì„œ ì¶©ëŒ ë°©ì§€
    """
    name = f"{base}{ext}"
    i = 1
    while os.path.exists(os.path.join(outdir, name)):
        name = f"{base}_{i}{ext}"
        i += 1
    return name

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (ëª¨ë“ˆë¡œë§Œ ì‚¬ìš©) - CLI/ì§ì ‘ ì‹¤í–‰ ë°©ì§€
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    # ì¥ê³ ì—ì„œ import í•˜ì—¬ ì‚¬ìš©í•˜ë„ë¡ ì„¤ê³„. ì§ì ‘ ì‹¤í–‰ ë¡œì§ ì—†ìŒ.
    pass
